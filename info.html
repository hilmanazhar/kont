<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
    <meta name="theme-color" content="#f5f5f7">
    <title>Info Kontrakan - Catatan Kontrakan</title>
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" href="icons/icon-512.png">
    <link rel="stylesheet" href="css/style.css">
</head>

<body>
    <div class="container">
        <div class="page-header">
            <a href="dashboard.html" class="back-btn">
                <svg viewBox="0 0 24 24">
                    <line x1="19" y1="12" x2="5" y2="12" />
                    <polyline points="12 19 5 12 12 5" />
                </svg>
                Kembali
            </a>
            <button class="btn-pill" onclick="openAddInfoModal()">+ Tambah Info</button>
        </div>

        <h1 style="margin-bottom: var(--space-xl);">Semua Info</h1>

        <div class="section">
            <div id="infoList">
                <div class="empty-state">
                    <div class="spinner" style="margin: 0 auto;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Info Detail Modal -->
    <div class="modal-overlay" id="infoDetailModal">
        <div class="modal">
            <div class="modal-handle"></div>
            <div id="infoDetailContent"></div>
        </div>
    </div>

    <!-- Add Info Modal -->
    <div class="modal-overlay" id="addInfoModal">
        <div class="modal">
            <div class="modal-handle"></div>
            <h3 class="modal-title">Tambah Info</h3>
            <form id="addInfoForm" enctype="multipart/form-data">
                <div class="form-group">
                    <label class="form-label">Judul</label>
                    <input type="text" class="form-control" id="infoTitle" placeholder="Judul info..." required>
                </div>
                <div class="form-group">
                    <label class="form-label">Deskripsi</label>
                    <textarea class="form-control" id="infoContent" rows="4" placeholder="Detail info..."></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Gambar (Opsional)</label>
                    <div class="upload-area" id="uploadArea">
                        <svg viewBox="0 0 24 24"
                            style="width: 24px; height: 24px; stroke: var(--text-muted); stroke-width: 1.5; fill: none; margin-bottom: 8px;">
                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2" />
                            <circle cx="8.5" cy="8.5" r="1.5" />
                            <polyline points="21 15 16 10 5 21" />
                        </svg>
                        <div>Tap untuk upload</div>
                        <input type="file" id="infoImageInput" accept="image/*" hidden>
                        <img id="infoImagePreview" class="upload-preview hidden">
                    </div>
                </div>
                <div style="display: flex; gap: var(--space-sm);">
                    <button type="button" class="btn btn-full" onclick="closeModal('addInfoModal')">Batal</button>
                    <button type="submit" class="btn btn-primary btn-full">Simpan</button>
                </div>
            </form>
        </div>
    </div>

    <script src="js/icons.js"></script>
    <script src="js/app.js"></script>
    <script>
        (async () => {
            if (!await checkAuth()) { window.location.href = 'login.html'; return; }
            await loadInfoList();
        })();

        async function loadInfoList() {
            const container = document.getElementById('infoList');
            try {
                const res = await fetch(`${API_BASE}/info.php?limit=50`, { credentials: 'include' });
                const data = await res.json();

                if (!data.info || data.info.length === 0) {
                    container.innerHTML = '<div class="empty-state">Belum ada info</div>';
                    return;
                }

                container.innerHTML = data.info.map(i => `
                    <div class="info-item" onclick="showInfoDetail(${JSON.stringify(i).replace(/"/g, '&quot;')})">
                        <div class="info-bullet"></div>
                        <div class="info-content">
                            <div class="info-header">
                                <div class="info-title">${i.author_name} - ${i.title}</div>
                                <div class="info-date">${formatDateShort(i.created_at)}</div>
                            </div>
                            <div class="info-desc">${i.content || ''}</div>
                        </div>
                        ${i.image_path ? `<img src="${imageUrl(i.image_path)}" class="info-image" alt="">` : ''}
                    </div>
                `).join('');
            } catch {
                container.innerHTML = '<div class="empty-state">Gagal memuat</div>';
            }
        }

        function formatDateShort(dateStr) {
            const d = new Date(dateStr);
            return d.toLocaleDateString('id-ID', { day: '2-digit', month: '2-digit', year: '2-digit' });
        }

        function showInfoDetail(info) {
            const content = document.getElementById('infoDetailContent');
            content.innerHTML = `
                ${info.image_path ? `<img src="${imageUrl(info.image_path)}" class="info-detail-image" alt="">` : ''}
                <h2 style="margin-bottom: var(--space-sm);">${info.title}</h2>
                <div class="info-detail-meta">${info.author_name} Â· ${formatDateShort(info.created_at)}</div>
                <div class="info-detail-content">${info.content || 'Tidak ada deskripsi'}</div>
                ${(info.user_id == state.user.id || state.user.role === 'admin') ? `
                    <button class="btn btn-danger btn-full mt-md" onclick="deleteInfo(${info.id})">Hapus Info</button>
                ` : ''}
            `;
            openModal('infoDetailModal');
        }

        async function deleteInfo(id) {
            if (!confirm('Hapus info ini?')) return;
            try {
                await apiDelete('info.php?id=' + id);
                showToast('Dihapus', 'success');
                closeModal('infoDetailModal');
                await loadInfoList();
            } catch { showToast('Gagal', 'error'); }
        }

        function openAddInfoModal() { openModal('addInfoModal'); }

        // Image upload
        const uploadArea = document.getElementById('uploadArea');
        const imageInput = document.getElementById('infoImageInput');
        const imagePreview = document.getElementById('infoImagePreview');

        uploadArea.addEventListener('click', () => imageInput.click());

        imageInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                imagePreview.src = e.target.result;
                imagePreview.classList.remove('hidden');
                uploadArea.classList.add('has-file');
            };
            reader.readAsDataURL(file);
        });

        document.getElementById('addInfoForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const formData = new FormData();
            formData.append('title', document.getElementById('infoTitle').value.trim());
            formData.append('content', document.getElementById('infoContent').value.trim());

            if (imageInput.files[0]) {
                formData.append('image', imageInput.files[0]);
            }

            try {
                const res = await fetch(`${API_BASE}/info.php`, {
                    method: 'POST',
                    credentials: 'include',
                    body: formData
                });
                const data = await res.json();
                if (!res.ok) throw new Error(data.error);

                showToast('Info ditambahkan', 'success');
                closeModal('addInfoModal');
                await loadInfoList();

                // Reset form
                document.getElementById('addInfoForm').reset();
                imagePreview.classList.add('hidden');
                uploadArea.classList.remove('has-file');
            } catch (err) {
                showToast('Gagal: ' + err.message, 'error');
            }
        });

        ['infoDetailModal', 'addInfoModal'].forEach(id => {
            document.getElementById(id).addEventListener('click', (e) => {
                if (e.target.classList.contains('modal-overlay')) closeModal(id);
            });
        });
    </script>
</body>

</html>