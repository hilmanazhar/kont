<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#fafafa">
    <title>Profil - Catatan Kontrakan</title>
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" href="icons/icon-512.png">
    <link rel="stylesheet" href="css/style.css">
    <style>
        .qris-preview {
            max-width: 150px;
            border-radius: var(--radius-md);
            margin-top: var(--space-sm);
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="page-header">
            <h1 class="page-title">Profil</h1>
            <button class="icon-btn" onclick="toggleTheme()"><span class="theme-toggle-icon"></span></button>
        </div>

        <!-- Compact Profile Card -->
        <div class="section"
            style="display: flex; align-items: center; gap: var(--space-md); padding: var(--space-md);">
            <div class="avatar" style="width: 48px; height: 48px; font-size: 1.25rem; flex-shrink: 0;"
                id="profileAvatar">?</div>
            <div style="flex: 1;">
                <h3 id="profileName" style="margin: 0; font-size: 1rem;">Loading...</h3>
                <p class="text-muted" id="profileRole" style="font-size: 0.75rem; margin: 0;">-</p>
            </div>
            <button class="btn btn-danger" style="padding: var(--space-xs) var(--space-sm); font-size: 0.75rem;"
                id="logoutBtn">Keluar</button>
        </div>

        <!-- Basic Settings - Inline layout -->
        <div class="section">
            <div class="section-header" style="margin-bottom: var(--space-sm);">
                <span class="icon"><svg viewBox="0 0 24 24">
                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2" />
                        <circle cx="12" cy="7" r="4" />
                    </svg></span>
                <span class="section-title">Pengaturan</span>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-sm);">
                <div class="form-group" style="margin-bottom: 0;">
                    <label class="form-label" style="font-size: 0.7rem;">Nama Tampilan</label>
                    <input type="text" class="form-control" id="displayName" style="padding: var(--space-sm);">
                </div>
                <div class="form-group" style="margin-bottom: 0;">
                    <label class="form-label" style="font-size: 0.7rem;">No. WhatsApp</label>
                    <input type="tel" class="form-control" id="phoneWa" placeholder="08xx"
                        style="padding: var(--space-sm);">
                </div>
            </div>
            <button class="btn btn-primary btn-full" id="saveProfileBtn"
                style="margin-top: var(--space-sm);">Simpan</button>
        </div>

        <!-- Payment Methods - Multiple Items -->
        <div class="section">
            <div class="section-header" style="margin-bottom: var(--space-sm);">
                <span class="icon"><svg viewBox="0 0 24 24">
                        <rect x="1" y="4" width="22" height="16" rx="2" ry="2" />
                        <line x1="1" y1="10" x2="23" y2="10" />
                    </svg></span>
                <span class="section-title">Info Pembayaran</span>
            </div>
            <p class="text-muted" style="font-size: 0.7rem; margin-bottom: var(--space-md);">Info ini ditampilkan saat
                teman bayar hutang ke kamu</p>

            <!-- Banks Section -->
            <div style="margin-bottom: var(--space-md);">
                <div
                    style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-xs);">
                    <span
                        style="font-weight: 600; font-size: 0.8rem; display: flex; align-items: center; gap: 6px;"><svg
                            viewBox="0 0 24 24"
                            style="width: 16px; height: 16px; stroke: currentColor; fill: none; stroke-width: 2;">
                            <rect x="3" y="10" width="18" height="11" rx="2" />
                            <path d="M12 2L3 10h18L12 2z" />
                        </svg> Rekening Bank</span>
                    <button class="btn" style="padding: 4px 8px; font-size: 0.7rem;" onclick="showAddBankForm()">+
                        Tambah</button>
                </div>
                <div id="banksList" style="font-size: 0.8rem;"></div>
                <div id="addBankForm" class="hidden"
                    style="background: var(--bg-hover); padding: var(--space-sm); border-radius: var(--radius-md); margin-top: var(--space-xs);">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-xs);">
                        <input type="text" class="form-control" id="newBankName" placeholder="Nama Bank"
                            style="padding: 6px; font-size: 0.75rem;">
                        <input type="text" class="form-control" id="newBankAccount" placeholder="No. Rekening"
                            style="padding: 6px; font-size: 0.75rem;">
                    </div>
                    <div style="display: flex; gap: var(--space-xs); margin-top: var(--space-xs);">
                        <button class="btn btn-primary" style="padding: 4px 8px; font-size: 0.7rem; flex: 1;"
                            onclick="addBank()">Simpan</button>
                        <button class="btn" style="padding: 4px 8px; font-size: 0.7rem;"
                            onclick="hideAddBankForm()">Batal</button>
                    </div>
                </div>
            </div>

            <!-- E-Wallets Section -->
            <div style="margin-bottom: var(--space-md);">
                <div
                    style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-xs);">
                    <span
                        style="font-weight: 600; font-size: 0.8rem; display: flex; align-items: center; gap: 6px;"><svg
                            viewBox="0 0 24 24"
                            style="width: 16px; height: 16px; stroke: currentColor; fill: none; stroke-width: 2;">
                            <rect x="5" y="2" width="14" height="20" rx="2" />
                            <line x1="12" y1="18" x2="12.01" y2="18" />
                        </svg> E-Wallet</span>
                    <button class="btn" style="padding: 4px 8px; font-size: 0.7rem;" onclick="showAddEwalletForm()">+
                        Tambah</button>
                </div>
                <div id="ewalletsList" style="font-size: 0.8rem;"></div>
                <div id="addEwalletForm" class="hidden"
                    style="background: var(--bg-hover); padding: var(--space-sm); border-radius: var(--radius-md); margin-top: var(--space-xs);">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-xs);">
                        <input type="text" class="form-control" id="newEwalletType" placeholder="Jenis (GoPay, OVO)"
                            style="padding: 6px; font-size: 0.75rem;">
                        <input type="text" class="form-control" id="newEwalletNumber" placeholder="No. E-Wallet"
                            style="padding: 6px; font-size: 0.75rem;">
                    </div>
                    <div style="display: flex; gap: var(--space-xs); margin-top: var(--space-xs);">
                        <button class="btn btn-primary" style="padding: 4px 8px; font-size: 0.7rem; flex: 1;"
                            onclick="addEwallet()">Simpan</button>
                        <button class="btn" style="padding: 4px 8px; font-size: 0.7rem;"
                            onclick="hideAddEwalletForm()">Batal</button>
                    </div>
                </div>
            </div>

            <!-- QRIS Section -->
            <div>
                <div
                    style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-xs);">
                    <span
                        style="font-weight: 600; font-size: 0.8rem; display: flex; align-items: center; gap: 6px;"><svg
                            viewBox="0 0 24 24"
                            style="width: 16px; height: 16px; stroke: currentColor; fill: none; stroke-width: 2;">
                            <rect x="3" y="3" width="18" height="18" rx="2" />
                            <rect x="7" y="7" width="3" height="3" />
                            <rect x="14" y="7" width="3" height="3" />
                            <rect x="7" y="14" width="3" height="3" />
                            <path d="M14 14h3v3" />
                        </svg> QRIS</span>
                    <label class="btn" style="padding: 4px 8px; font-size: 0.7rem; cursor: pointer;">
                        + Tambah
                        <input type="file" id="qrisInput" accept="image/*" hidden onchange="addQris(this)">
                    </label>
                </div>
                <div id="qrisList" style="display: flex; flex-wrap: wrap; gap: var(--space-xs);"></div>
            </div>
        </div>

        <!-- Password - Compact -->
        <div class="section">
            <div class="section-header" style="margin-bottom: var(--space-sm);">
                <span class="icon"><svg viewBox="0 0 24 24">
                        <rect x="3" y="11" width="18" height="11" rx="2" ry="2" />
                        <path d="M7 11V7a5 5 0 0 1 10 0v4" />
                    </svg></span>
                <span class="section-title">Ubah Password</span>
            </div>
            <form id="passwordForm">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-sm);">
                    <div class="form-group" style="margin-bottom: 0;">
                        <label class="form-label" style="font-size: 0.7rem;">Password Baru</label>
                        <input type="password" class="form-control" id="newPassword" required minlength="6"
                            style="padding: var(--space-sm);">
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <label class="form-label" style="font-size: 0.7rem;">Konfirmasi</label>
                        <input type="password" class="form-control" id="confirmPassword" required minlength="6"
                            style="padding: var(--space-sm);">
                    </div>
                </div>
                <button type="submit" class="btn btn-full" style="margin-top: var(--space-sm);">Ubah Password</button>
            </form>
        </div>

        <!-- Admin -->
        <div class="section hidden" id="adminSection" style="padding: var(--space-md);">
            <a href="admin.html" class="btn btn-full">üîê Buka Admin Panel</a>
        </div>
    </div>

    <!-- Bottom Nav -->
    <nav class="bottom-nav">
        <a href="dashboard.html" class="nav-item">
            <span class="icon"><svg viewBox="0 0 24 24">
                    <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z" />
                    <polyline points="9 22 9 12 15 12 15 22" />
                </svg></span>
            <span>Home</span>
        </a>
        <a href="history.html" class="nav-item">
            <span class="icon"><svg viewBox="0 0 24 24">
                    <path d="M12 8v4l3 3" />
                    <circle cx="12" cy="12" r="10" />
                </svg></span>
            <span>Riwayat</span>
        </a>
        <a href="settle.html" class="nav-item">
            <span class="icon"><svg viewBox="0 0 24 24">
                    <rect x="1" y="4" width="22" height="16" rx="2" ry="2" />
                    <line x1="1" y1="10" x2="23" y2="10" />
                </svg></span>
            <span>Bayar</span>
        </a>
        <a href="notifications.html" class="nav-item">
            <span class="icon"><svg viewBox="0 0 24 24">
                    <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9" />
                    <path d="M13.73 21a2 2 0 0 1-3.46 0" />
                </svg></span>
            <span>Notif</span>
            <span class="nav-badge hidden">0</span>
        </a>
        <a href="profile.html" class="nav-item active">
            <span class="icon"><svg viewBox="0 0 24 24">
                    <circle cx="12" cy="12" r="3" />
                    <path
                        d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z" />
                </svg></span>
            <span>Profil</span>
        </a>
    </nav>

    <script src="js/icons.js"></script>
    <script src="js/app.js"></script>
    <script>
        // Payment methods state
        let paymentMethods = { banks: [], ewallets: [], qris: [] };

        (async () => {
            if (!await checkAuth()) { window.location.href = 'login.html'; return; }
            await loadNotifications();

            document.getElementById('profileAvatar').textContent = getUserInitials(state.user.display_name);
            document.getElementById('profileName').textContent = state.user.display_name;
            document.getElementById('profileRole').textContent = state.user.role === 'admin' ? 'Administrator' : 'Member';
            document.getElementById('displayName').value = state.user.display_name;
            document.getElementById('phoneWa').value = state.user.phone_wa || '';

            if (state.user.role === 'admin') document.getElementById('adminSection').classList.remove('hidden');

            // Load payment methods
            await loadPaymentMethods();
        })();

        async function loadPaymentMethods() {
            try {
                const res = await fetch(`${API_BASE}/payment_info.php?user_id=${state.user.id}`, { credentials: 'include' });
                const data = await res.json();
                if (data.payment_info) {
                    const p = data.payment_info;
                    // Use parsed payment_methods or fallback to legacy
                    if (p.payment_methods_parsed) {
                        paymentMethods = p.payment_methods_parsed;
                    } else {
                        // Legacy fallback
                        paymentMethods = { banks: [], ewallets: [], qris: [] };
                        if (p.bank_name) paymentMethods.banks.push({ name: p.bank_name, account: p.bank_account || '' });
                        if (p.ewallet_type) paymentMethods.ewallets.push({ type: p.ewallet_type, number: p.ewallet_number || '' });
                        if (p.qris_image) paymentMethods.qris.push(p.qris_image);
                    }
                }
                renderPaymentMethods();
            } catch (err) { console.error(err); }
        }

        function renderPaymentMethods() {
            // Render banks
            const banksList = document.getElementById('banksList');
            if (paymentMethods.banks.length === 0) {
                banksList.innerHTML = '<div class="text-muted" style="font-size: 0.75rem;">Belum ada rekening</div>';
            } else {
                banksList.innerHTML = paymentMethods.banks.map((b, i) => `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 6px 8px; background: var(--bg-card); border-radius: var(--radius-sm); margin-bottom: 4px;">
                        <div><strong>${b.name}</strong> - ${b.account}</div>
                        <button onclick="removeBank(${i})" style="background: none; border: none; color: var(--red); cursor: pointer; font-size: 0.8rem;">‚úï</button>
                    </div>
                `).join('');
            }

            // Render ewallets
            const ewalletsList = document.getElementById('ewalletsList');
            if (paymentMethods.ewallets.length === 0) {
                ewalletsList.innerHTML = '<div class="text-muted" style="font-size: 0.75rem;">Belum ada e-wallet</div>';
            } else {
                ewalletsList.innerHTML = paymentMethods.ewallets.map((e, i) => `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 6px 8px; background: var(--bg-card); border-radius: var(--radius-sm); margin-bottom: 4px;">
                        <div><strong>${e.type}</strong> - ${e.number}</div>
                        <button onclick="removeEwallet(${i})" style="background: none; border: none; color: var(--red); cursor: pointer; font-size: 0.8rem;">‚úï</button>
                    </div>
                `).join('');
            }

            // Render QRIS
            const qrisList = document.getElementById('qrisList');
            if (paymentMethods.qris.length === 0) {
                qrisList.innerHTML = '<div class="text-muted" style="font-size: 0.75rem;">Belum ada QRIS</div>';
            } else {
                qrisList.innerHTML = paymentMethods.qris.map((q, i) => `
                    <div style="position: relative; display: inline-block;">
                        <img src="${imageUrl(q)}" style="width: 60px; height: 60px; object-fit: cover; border-radius: var(--radius-sm);">
                        <button onclick="removeQris(${i})" style="position: absolute; top: -5px; right: -5px; background: var(--red); color: white; border: none; border-radius: 50%; width: 18px; height: 18px; font-size: 10px; cursor: pointer;">‚úï</button>
                    </div>
                `).join('');
            }
        }

        // Bank functions
        function showAddBankForm() { document.getElementById('addBankForm').classList.remove('hidden'); }
        function hideAddBankForm() { document.getElementById('addBankForm').classList.add('hidden'); document.getElementById('newBankName').value = ''; document.getElementById('newBankAccount').value = ''; }

        async function addBank() {
            const name = document.getElementById('newBankName').value.trim();
            const account = document.getElementById('newBankAccount').value.trim();
            if (!name || !account) { showToast('Isi nama bank dan no rekening', 'error'); return; }

            try {
                const formData = new FormData();
                formData.append('action', 'add');
                formData.append('type', 'bank');
                formData.append('name', name);
                formData.append('account', account);

                await fetch(`${API_BASE}/payment_info.php`, { method: 'POST', credentials: 'include', body: formData });
                showToast('Bank ditambahkan', 'success');
                hideAddBankForm();
                await loadPaymentMethods();
            } catch { showToast('Gagal', 'error'); }
        }

        async function removeBank(index) {
            if (!confirm('Hapus rekening ini?')) return;
            try {
                const formData = new FormData();
                formData.append('action', 'remove');
                formData.append('type', 'bank');
                formData.append('index', index);
                await fetch(`${API_BASE}/payment_info.php`, { method: 'POST', credentials: 'include', body: formData });
                showToast('Dihapus', 'success');
                await loadPaymentMethods();
            } catch { showToast('Gagal', 'error'); }
        }

        // E-wallet functions
        function showAddEwalletForm() { document.getElementById('addEwalletForm').classList.remove('hidden'); }
        function hideAddEwalletForm() { document.getElementById('addEwalletForm').classList.add('hidden'); document.getElementById('newEwalletType').value = ''; document.getElementById('newEwalletNumber').value = ''; }

        async function addEwallet() {
            const type = document.getElementById('newEwalletType').value.trim();
            const number = document.getElementById('newEwalletNumber').value.trim();
            if (!type || !number) { showToast('Isi jenis dan nomor e-wallet', 'error'); return; }

            try {
                const formData = new FormData();
                formData.append('action', 'add');
                formData.append('type', 'ewallet');
                formData.append('ewallet_type', type);
                formData.append('number', number);

                await fetch(`${API_BASE}/payment_info.php`, { method: 'POST', credentials: 'include', body: formData });
                showToast('E-Wallet ditambahkan', 'success');
                hideAddEwalletForm();
                await loadPaymentMethods();
            } catch { showToast('Gagal', 'error'); }
        }

        async function removeEwallet(index) {
            if (!confirm('Hapus e-wallet ini?')) return;
            try {
                const formData = new FormData();
                formData.append('action', 'remove');
                formData.append('type', 'ewallet');
                formData.append('index', index);
                await fetch(`${API_BASE}/payment_info.php`, { method: 'POST', credentials: 'include', body: formData });
                showToast('Dihapus', 'success');
                await loadPaymentMethods();
            } catch { showToast('Gagal', 'error'); }
        }

        // QRIS functions
        async function addQris(input) {
            const file = input.files[0];
            if (!file) return;

            try {
                const formData = new FormData();
                formData.append('action', 'add');
                formData.append('type', 'qris');
                formData.append('qris_image', file);

                await fetch(`${API_BASE}/payment_info.php`, { method: 'POST', credentials: 'include', body: formData });
                showToast('QRIS ditambahkan', 'success');
                input.value = '';
                await loadPaymentMethods();
            } catch { showToast('Gagal', 'error'); }
        }

        async function removeQris(index) {
            if (!confirm('Hapus QRIS ini?')) return;
            try {
                const formData = new FormData();
                formData.append('action', 'remove');
                formData.append('type', 'qris');
                formData.append('index', index);
                await fetch(`${API_BASE}/payment_info.php`, { method: 'POST', credentials: 'include', body: formData });
                showToast('Dihapus', 'success');
                await loadPaymentMethods();
            } catch { showToast('Gagal', 'error'); }
        }

        // Profile settings
        document.getElementById('saveProfileBtn').addEventListener('click', async () => {
            try {
                await apiPut('users.php', {
                    display_name: document.getElementById('displayName').value.trim(),
                    phone_wa: document.getElementById('phoneWa').value.trim()
                });
                showToast('Tersimpan', 'success');
            } catch { showToast('Gagal', 'error'); }
        });

        // Password change
        document.getElementById('passwordForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const pw = document.getElementById('newPassword').value;
            if (pw !== document.getElementById('confirmPassword').value) {
                showToast('Password tidak cocok', 'error');
                return;
            }
            try {
                await apiPut('users.php', { new_password: pw });
                showToast('Password diubah', 'success');
                document.getElementById('passwordForm').reset();
            } catch { showToast('Gagal', 'error'); }
        });

        // Logout
        document.getElementById('logoutBtn').addEventListener('click', async () => {
            if (confirm('Keluar?')) await logout();
        });
    </script>
</body>

</html>